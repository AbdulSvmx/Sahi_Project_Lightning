_setSpeed(100);
//Pass the Attack Values
var $attackTag = "<img  src=p onerror=alert(123)>";
var $attackTagSelectionField = "/img src=p/"
//	Pass the URl/Page Locations
var $urlArray = $excel.readFromCustomExcel("../xss/xss_excelData/xssData.xlsx","Sheet1", false, true)
//			var $urlArray =
//			["https://svmxc.na40.visual.force.com/apex/SVMXC__SPM_configuration"];
$bo_act_login.login("https://login.salesforce.com", "yadav.thyagaraj@ge.com","Svmx123#")

var $urlCount = 0;
var int = 0;

runScan();
pritnStatus();

function pritnStatus() {
	_logOutput(" | URL Scanned : " + $urlCount + 1 + " Of Total : "
			+ $urlArray.length);
}

function runScan() {

	for (int = 0; int < $urlArray.length; int++) {

		$urlCount = int;
		$url = $urlArray[int]["URL"];
		_log("SCANNED PAGE : [ " + $url + " ]");
		_navigateTo($url);
		_call(top.location.reload(true));
		_wait(2000);
		_continueOnError();

		captureAttack();

		// Collect and naviagte through Tabs if present and set all the fields
		// for
		// each page
		_selectWindow();
		if (_isVisible(_span("/svmx-tab/"))) {
			var $tabbing = _collect("_span", "/svmx-tab/");

		} else {

			var $tabbing = _collect("_cell", "/rich-tab-header/");
		}

		_log("Collected Spans = " + $tabbing.length);
		// To avoid Tabbing in non tabbed pages
		if ($tabbing.length == 0) {
			var $tabs = 1;
			var skipFlag = 1;
		} else {
			var $tabs = $tabbing.length;
			var skipFlag = 0;
		}

		// Select a Tab
		for (var $s = 0; $s < $tabs; $s++) {
			_setStrictVisibilityCheck(true);
			var $t;
		
				_disableDefaultErrorLogging();
				_maskLogs();
				if (skipFlag != 1) {
					if (_isVisible($tabbing[$s])) {
						$t = _getText($tabbing[$s]);
						_click($tabbing[$s]);
						captureAttack();
						_log("in TAB ******************* " + $t + "****");
					}
					
				}
			
			_unmaskLogs();
			_enableDefaultErrorLogging();
			
			captureAttack();
			_setStrictVisibilityCheck(true);
			killWindow();
			// Initial check
			captureAttack();
			outerNewPageActions();
			innerNewPageActions()
			attackTextbox();
			attackTextArea();
			attackSelection();
			attackSelectionEditable();
			postPageActions();
			killWindow();

			_wait(3000);

		}

	}

}

function outerNewPageActions() {
	$buttonArray = [ "/New/", "/Add/", "/edit-icon/" ];

	$buttonArray.forEach(function newPageActions($buttonName, $index) {
		_log("Outer Page Acting on Button : "+$buttonName);
		//This is 1st set of if-else
		if (_isVisible(_button($buttonName))) {
			_click(_button($buttonName));
			captureAttack();
		}

		else if (_isVisible(_span($buttonName))) {
			_click(_span($buttonName));
			captureAttack();
		}

		else if (_isVisible(_link($buttonName))) {
			_click(_link($buttonName));
			captureAttack();
		}

		else if (_isVisible(_image($buttonName))) {
			_click(_image($buttonName));
			captureAttack();
		}

		
		//After selecting a profile new set of buttons will appear
		if (_isVisible(_textbox("/Select a profile/"))) {
			_click(_textbox("/Select a profile/"));
			_click(_listItem("/Default/"));
			captureAttack();
		}else{
			//do nothing
		}

		//This is 2nd set of if-else
		 if (_isVisible(_button($buttonName))) {
			_click(_button($buttonName));
			captureAttack();
		}

		else if (_isVisible(_span($buttonName))) {
			_click(_span($buttonName));
			captureAttack();
		}

		else if (_isVisible(_link($buttonName))) {
			_click(_link($buttonName));
			captureAttack();
		}

		else if (_isVisible(_image($buttonName))) {
			_click(_image($buttonName));
			captureAttack();
		}
		_setStrictVisibilityCheck(false);
	})

}

function innerNewPageActions() {
	$buttonArray = [ "/New/", "/Add/", "/edit-icon/" ];

	$buttonArray.forEach(function newPageActions($buttonName, $index) {
		_log("Inner Page Acting on Button : "+$buttonName);
		
		
		//After selecting a profile new set of buttons will appear
		if (_isVisible(_textbox("/Select a profile/"))) {
			_click(_textbox("/Select a profile/"));
			_click(_listItem("/Default/"));
			captureAttack();
		}else{
			//do nothing
		}

		//This is 2nd set of if-else
		 if (_isVisible(_button($buttonName))) {
			_click(_button($buttonName));
			captureAttack();
		}

		else if (_isVisible(_span($buttonName))) {
			_click(_span($buttonName));
			captureAttack();
		}

		else if (_isVisible(_link($buttonName))) {
			_click(_link($buttonName));
			captureAttack();
		}

		else if (_isVisible(_image($buttonName))) {
			_click(_image($buttonName));
			captureAttack();
		}
		_setStrictVisibilityCheck(false);
	})

}

function postPageActions() {

	$buttonArray = [ "/Update/", "/Save/", "Quick Save", "OK", "Ok",
	                 "svmx-tool-close" ];

	$buttonArray.forEach(function newPageActions($buttonName, $index) {
		_log("Acting on Button : "+$buttonName);
		_setStrictVisibilityCheck(true);
		if (_isVisible(_span($buttonName))) {
			_click(_span($buttonName));

			captureAttack();
		}

		else if (_isVisible(_span($buttonName))) {
			_click(_span($buttonName));

			captureAttack();
		}

		else if (_isVisible(_button($buttonName))) {
			_click(_button($buttonName));

			captureAttack();
		}

		else if (_isVisible(_button($buttonName))) {
			_click(_button($buttonName));

			captureAttack();
		}

		else if (_isVisible(_link($buttonName))) {
			_click(_link($buttonName));

			captureAttack();
		} else if (_isVisible(_span($buttonName))) {
			_click(_span($buttonName));

			captureAttack();
		}

		else if (_isVisible(_image($buttonName))) {
			_click(_image($buttonName));

			captureAttack();

		}
		_setStrictVisibilityCheck(false);

	}

	)

}

function killWindow() {

	var $recentWindowId = _getRecentWindow().sahiWinId;
	if (_windowExists($recentWindowId, 10)) {
		
			_selectWindow($recentWindowId);
			_closeWindow();
		
	}

	_selectWindow();
	_focusWindow();

}

function captureAttack() {
	_log("************************************");
	var $allAlerts = _lastAlert(true);
	if ($allAlerts == null || $allAlerts == "") {
		//_log("SCANNED PAGE : [ " + $urlArray[int] + " ] No Alerts Caught")
	} else {

		var $logStr = " | SCANNED PAGE : [ " + $urlArray[int]
		+ " ] Alerts Caught : " + $allAlerts;
		_log($logStr, "FAILURE")
		_logOutput($logStr);
		_lockWindow();
		_focusWindow();
		_takePageScreenShot();
		_unlockWindow();
		_clearLastAlert();

	}
	_log("************************************");
	killWindow();

}

function attackTextbox() {
	var $textboxes = _collect("_textbox", "/svmx-textfield||svmx-form-text/");
	_log("Collected $textboxes = " + $textboxes.length);
	// Iterate and set values on all textboxes and also textcombo/selection
	// boxes
	for (var $i = 0; $i < $textboxes.length; $i++) {

	
			_disableDefaultErrorLogging();
			_maskLogs();
			_setValue($textboxes[$i], $attackTag);
			_unmaskLogs();
			_enableDefaultErrorLogging();

	
		captureAttack();
		// For Selection/ComboBox
		
			if (_isVisible(_listItem($attackTag))) {
				_disableDefaultErrorLogging();
				_maskLogs();
				_click(_listItem($attackTag));
				_unmaskLogs();
				_enableDefaultErrorLogging();

			}

	
		captureAttack();

	}
}

function attackTextArea() {
	var $textarea = _collect("_textarea", "/.*/");
	_log("Collected $textarea = " + $textarea.length);

	// Iterate and set values on all text areas
	for (var $i = 0; $i < $textarea.length; $i++) {

		
			_disableDefaultErrorLogging();
			_maskLogs();
			_setValue($textarea[$i], $attackTag);
			_unmaskLogs();
			_enableDefaultErrorLogging();

	
		captureAttack();
	}
}

function attackSelectionEditable() {
	var $cell = _collect("_cell", "/x-grid-cell/");
	_log("Collected $cell = " + $cell.length);

	// Iterate and set values on all editable selections
	for (var $i = 0; $i < $cell.length; $i++) {

		
			if (_isVisible($select[$i])) {
				_disableDefaultErrorLogging();
				_maskLogs();
				_doubleClick($cell[$i]);
				_call($cell[$i].innerHTML = $attackTag);
				_unmaskLogs();
				_enableDefaultErrorLogging();

			}

	
		captureAttack();
	}
}

function attackSelection() {
	var $select = _collect("_select", "/.*/");
	_log("Collected $select = " + $select.length);

	// Iterate and set values on all editable selections
	for (var $i = 0; $i < $select.length; $i++) {

		

			if (_isVisible($select[$i])) {
				_disableDefaultErrorLogging();
				_maskLogs();
				_setSelected($select[$i], $attackTagSelectionField);
				_unmaskLogs();
				_enableDefaultErrorLogging();
			}

		
		captureAttack();
	}
}
