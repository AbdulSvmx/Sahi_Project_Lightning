var $user_credentials = $excel.readFromCustomExcel("../optimax/op_excleData/automation.xlsx", "User_Details","","");
var $work_Orders_Xl = $excel.readFromCustomExcel("../optimax/op_excleData/automation.xlsx", "Work_Orders","","");
//var $nArr;
//Calling the sforce API
for(var $i=0;$i<$user_credentials.length;$i++)
{
var $g_un = $user_credentials[$i][0];
var $g_pwd = $user_credentials[$i][1];
var $g_url = $user_credentials[$i][2];
}

var $RS_6295 = _testcase("RS_6295", "Create New MTTS Rule");

$RS_6295.start();

var $g_url = "https://test.salesforce.com/";
var $g_un = "govendhan@svmx-cct5.org.cct5part1";
var $g_pwd = "maxpl0re2";

$bo_act_login.login($g_url, $g_un, $g_pwd);
		

var $date = "" + new Date();
var $MTTSName = "MTTSRule_" + $date;
var $rowCount = 0;

_wait(30000);
_click(_link("ServiceMax Setup"));
_wait(20000,_isVisible(_div("Dispatch Management")));
_click(_div("Dispatch Management"));
_wait(20000,_isVisible(_div("MTTS Rules")));
_click(_div("MTTS Rules"));
_set($rowCount, _table("MTTSRule:RuleForm:RuleBlock:MTTSRuleList").rows.length);
$rowCount=$rowCount-1;
_click(_button("New Rule"));
_setValue(_textbox("MTTSRule:RuleForm:RuleBlock:MTTSRuleList:"+$rowCount+":j_id90"), $MTTSName);
_setValue(_textarea("MTTSRule:RuleForm:RuleBlock:MTTSRuleList:"+$rowCount+":j_id94"), "MTTS Rule Automation");
_setSelected(_select("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:0:j_id104"), "Order Status");
_setSelected(_select("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:0:j_id109"), "Equals");
_setValue(_textbox("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:0:j_id113"), "Open");
_setSelected(_select("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:1:j_id104"), "Order Type");
_setSelected(_select("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:1:j_id109"), "Equals");
_setValue(_textbox("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:1:j_id113"), "Cleaning");
_click(_imageSubmitButton("Add"));
_setSelected(_select("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:2:j_id104"), "Order Type");
_setSelected(_select("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:2:j_id109"), "Equals");
_setValue(_textbox("MTTSRule:RuleForm:RuleBlock:j_id98:j_id99:table1:2:j_id113"), "Repair");
_setValue(_textbox("MTTSRule:RuleForm:RuleBlock:j_id119:HdrAdvOption"), "1 AND (2 OR3)");;
_setValue(_textbox("MTTSRule:RuleForm:RuleBlock:MTTS:Minutes"), "70");
_click(_button("Save"));

_log("$MTTSName = "+$MTTSName);

if(_exists($MTTSName))
	{
	_log("MTTS Rule Created Successfully");
	}
else
	{
	_fail("Error in Creating MTTS Rule");
	}

$RS_6295.end();

var $validate_WO_MTTS = _testcase("RS_6295", "Validating the MTTS by creating valid WO");

$validate_WO_MTTS.start();

_set($login_result, _fetch(login($g_un,$g_pwd)));
_log($login_result);

_set($create_MTTS_WO, _fetch(create_WO($work_Orders_Xl)));
_log($create_MTTS_WO);

//<browser>
function login($g_un,$g_pwd){
	
	var $login_result = sforce.connection.login($g_un,$g_pwd);
	return $login_result;
}

function create_WO ($work_Orders_Xl){
	var CreateRecords=[];
	for(var $i=0;$i<$work_Orders_Xl.length;$i++)
	{
		var wo_list = new sforce.SObject("SVMXC__Service_Order__c");
		wo_list.SVMXC__Order_Type__c = $work_Orders_Xl[$i][0];
		wo_list.SVMXC__Order_Status__c = $work_Orders_Xl[$i][1];
		CreateRecords.push(wo_list);
	}
	result = sforce.connection.create(CreateRecords);
	if(result.length != 0){
		_log("Work Orders are created");
		for (var i=0; i<result.length; i++) {
			var mtts_WO_List = sforce.connection.query("Select Id, SVMXC__Service_Duration__c, SVMXC__Order_Type__c, SVMXC__Order_Status__c From SVMXC__Service_Order__c Where Id = '" +result[i].id+"'");
			var mtts_WO_arr = mtts_WO_List.getArray("records");
			for(var $s=0;$s<mtts_WO_arr.length;$s++){
				var mtts_WO = mtts_WO_arr[$s];
				_log("SVMXC__Order_Type__c = "+mtts_WO.SVMXC__Order_Type__c+" , SVMXC__Order_Status__c = "+mtts_WO.SVMXC__Order_Status__c+" , SVMXC__Service_Duration__c = "+ mtts_WO.SVMXC__Service_Duration__c);
				if(mtts_WO.SVMXC__Order_Type__c === 'Cleaning' & mtts_WO.SVMXC__Order_Status__c === 'Open' & mtts_WO.SVMXC__Service_Duration__c === '4200.0'){
					_log("MTTS updated as expected from MTTS Rule i.e 4200 sec");
				}
				if(mtts_WO.SVMXC__Order_Type__c === 'Repair' & mtts_WO.SVMXC__Order_Status__c === 'Closed' & mtts_WO.SVMXC__Service_Duration__c === '3600.0'){
					_log("MTTS updated as expected from Setting def value 3600 sec");
				}
				else{
					_log("MTTS is not calculated. SVMXC__Service_Duration__c = "+ mtts_WO.SVMXC__Service_Duration__c);
				}
			}
		}
	}
	else{
		_log("Work Orders are not created");
	}
}

//</browser>
$validate_WO_MTTS.end();
